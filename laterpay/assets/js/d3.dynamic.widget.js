var margin={top:45,right:40,bottom:20,left:50};margin.xAxis=margin.left+margin.right,margin.yAxis=margin.top+margin.bottom;var LPCurve=function(t){var a,e=this;this.container=t,this.interpolation="linear",this.minPrice=0,this.maxPrice=5,this.todayPrice=0,this.pubDays=0,this.defaultPrice=.99,this.i18nDefaultPrice=lpVars.i18nDefaultPrice,this.currency=lpVars.currency,this.i18nDays=lpVars.i18nDays,this.dragging=!1,a=d3.select(t).append("svg").append("g"),a.append("rect").attr("class","background"),a.append("g").attr("class","x axis"),a.append("g").attr("class","y axis"),a.append("defs").append("marker").attr({id:"arrow-x","class":"arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,0 V4 L4,2 Z"),a.append("defs").append("marker").attr({id:"arrow-y","class":"arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,4 H4 L2,0 Z"),a.append("line").attr("class","default-price"),a.append("text").attr("text-anchor","middle").attr("class","default-price").text(this.i18nDefaultPrice),a.append("path").attr("class","line"),a.append("rect").attr({"class":"start-price",width:32,rx:3,height:29,ry:3}),a.append("text").attr("class","start-price").attr("text-anchor","end"),a.append("text").attr("class","start-price-currency").attr("text-anchor","end").text(this.currency),a.append("path").attr("class","start-price-triangle"),a.append("rect").attr({"class":"end-price",width:32,rx:3,height:29,ry:3}),a.append("text").attr("class","end-price").attr("text-anchor","end"),a.append("text").attr("class","end-price-currency").attr("text-anchor","end").text(this.currency),a.append("path").attr("class","end-price-triangle"),this.svg=a,jQuery(window).bind("resize",function(){e.plot()})};LPCurve.prototype.interpolate=function(t){return this.interpolation=t,this},LPCurve.prototype.setPrice=function(t,a,e){return this.minPrice=t,this.maxPrice=a,e&&(this.defaultPrice=e),this},LPCurve.prototype.set_data=function(t){return this.data=t,this},LPCurve.prototype.set_today=function(t,a){return this.pubDays=t,this.todayPrice=a,this},LPCurve.prototype.get_data=function(){return this.data},LPCurve.prototype.plot=function(){function t(t,a){var e=h.invert(d3.event.y);e<y[0]&&(e=y[0]),e>y[1]&&(e=y[1]),t.y=e,0===a&&l.data[0].x===t.x?l.data[1].y=t.y:1===a?l.data[0].y=t.y:0===a&&l.data[l.data.length-1].x===t.x?l.data[l.data.length-2].y=t.y:a===l.data.length-2&&(l.data[l.data.length-1].y=t.y),l.plot()}function a(){l.dragging=!0,jQuery(l.container).toggleClass("dragging")}function e(){l.dragging=!1,jQuery(l.container).toggleClass("dragging")}function r(){clearInterval(Q),jQuery(l.container).toggleClass("ew-resize"),l.dragging=!1;for(var t=0,a=l.data.length;a>t;t++)l.data[t].x=Math.round(l.data[t].x);l.plot()}function n(){jQuery(l.container).toggleClass("ew-resize"),l.dragging=!0}function i(t,a){var e,r=p.invert(d3.event.x),n=a===l.data.length-2,i=a===l.data.length-3;if(n){var c=(r-t.x)/(1e3/V),d=function(){e=+t.x+c,e=Math.max(e,l.data[a].x+.51),e=Math.max(e,29.51),e=Math.min(e,60.49),t.x=e,p.domain(d3.extent(l.data,function(t){return t.x})),l.plot()};clearInterval(Q),Q=setInterval(d,1e3/V),d()}else i?(e=r,e=Math.max(e,l.data[a].x+.51),e=Math.min(e,60.49),l.data[a+2].x=e>=25?e+5:30,t.x=e,p.domain(d3.extent(l.data,function(t){return t.x})),l.plot()):(e=r,e=Math.max(e,l.data[a].x+.51),e=Math.min(e,l.data[a+2].x-.51),t.x=e,p.domain(d3.extent(l.data,function(t){return t.x})),l.plot())}var c,d,l=this,o=this.svg,s=this.dragging,u=jQuery(this.container).width()-margin.xAxis,x=jQuery(this.container).height()-margin.yAxis,p=d3.scale.linear().range([0,u+10]),h=d3.scale.linear().range([x,0]);d3.select(this.container).select("svg").attr({width:u+margin.xAxis,height:x+margin.yAxis}).select("g").attr("transform","translate("+(margin.left-10)+","+margin.top+")"),o.select(".background").transition().duration(s?0:250).attr({width:u+10,height:x});var g=d3.extent(l.data,function(t){return t.x}),y=[this.minPrice,this.maxPrice],f=d3.svg.axis().scale(p).tickSize(-x,0,0).ticks(7).orient("bottom"),m=d3.svg.axis().scale(h).tickSize(-x,0,0).ticks(7).orient("left");p.domain(g),h.domain(y),o.select("g.x.axis").attr({transform:"translate(0,"+x+")","marker-end":"url(#arrow-x)"}).transition().duration(s?0:250).call(f),o.select("g.y.axis").attr("marker-start","url(#arrow-y)").transition().duration(s?0:250).call(m),o.select("line.default-price").transition().duration(s?0:250).attr({x1:0,y1:h(this.defaultPrice),x2:u+10,y2:h(this.defaultPrice)}),o.select("text.default-price").transition().duration(s?0:250).attr({x:u/2,y:h(l.defaultPrice)});var v=d3.svg.line().interpolate(this.interpolation).x(function(t){return p(t.x)}).y(function(t){return h(t.y)});o.select("path.line").datum(l.data).transition().duration(s?0:250).attr("d",v);var P=d3.behavior.drag().on("dragstart",n).on("drag",i).on("dragend",r),b=d3.behavior.drag().on("dragstart",a).on("drag",t).on("dragend",e),w=l.data.length,k=o.selectAll("circle.draggable").data(l.data),A=o.selectAll(".line-price").data(l.data.slice(1,w)),M=o.selectAll(".today-price-line").data(l.data.slice(1,w)),D=o.selectAll(".line-price-visible").data(l.data.slice(1,w));o.select("rect.start-price").datum(l.data[0]).call(b).transition().duration(s?0:250).attr({x:function(){return-40},y:function(t){return h(t.y)-14.5}}),o.select("text.start-price").datum(l.data[0]).call(b).transition().duration(s?0:250).attr({x:function(){return-12},y:function(t){return h(t.y)-.5}}).text(function(t){return t.y.toFixed(2)}),o.select("text.start-price-currency").datum(l.data[0]).call(b).transition().duration(s?0:250).attr({x:function(){return-13},y:function(t){return h(t.y)+9.5}}),o.select("path.start-price-triangle").datum(l.data[0]).call(b).transition().duration(s?0:250).attr("d",function(t){return c=-8,d=h(t.y)-5,"M "+c+" "+d+" l 5 5 l -5 5 z"}),o.select("rect.end-price").datum(l.data[l.data.length-1]).call(b).transition().duration(s?0:250).attr({x:function(){return u+18},y:function(t){return h(t.y)-15}}),o.select("text.end-price").datum(l.data[l.data.length-1]).call(b).transition().duration(s?0:250).attr({x:function(){return u+46},y:function(t){return h(t.y)-1}}).text(function(t){return t.y.toFixed(2)}),o.select("text.end-price-currency").datum(l.data[l.data.length-1]).call(b).transition().duration(s?0:250).attr({x:function(){return u+46},y:function(t){return h(t.y)+9}}),o.select("path.end-price-triangle").datum(l.data[l.data.length-1]).call(b).transition().duration(s?0:250).attr("d",function(t){return c=u+18,d=h(t.y)+5,"M "+c+" "+d+" l 0 -10 l -5 5 z"});var C=o.selectAll(".x-drag-square").data(l.data.slice(1,w));C.enter().append("rect").attr("class",function(t,a){return a===l.data.length-2?"x-drag-square hidden":"x-drag-square"}).call(P),C.exit().remove(),C.transition().duration(s?0:250).attr({x:function(t){return p(t.x)-15},y:function(){return-40},width:30,rx:3,height:30,ry:3});var L=o.selectAll(".x-triangle-bottom").data(l.data.slice(1,w));L.enter().append("path").attr("class",function(t,a){return a===l.data.length-2?"x-triangle-bottom hidden":"x-triangle-bottom"}).call(P),L.exit().remove(),L.transition().duration(s?0:250).attr("d",function(t){return c=p(t.x)-5,d=-10,"M "+c+" "+d+" l 10 0 l -5 5 z"});var z=o.selectAll(".x-text-days").data(l.data.slice(1,w));z.enter().append("text").attr("class",function(t,a){return a===l.data.length-2?"x-text-days hidden":"x-text-days"}).call(P),z.exit().remove(),z.transition().duration(s?0:250).text(this.i18nDays).attr({x:function(t){return p(t.x)},y:function(){return-16},height:30,"text-anchor":"middle"});var j=o.selectAll(".x-text").data(l.data.slice(1,w));j.enter().append("text").attr("class",function(t,a){return a===l.data.length-2?"x-text hidden":"x-text"}).call(P),j.exit().remove(),j.transition().duration(s?0:250).text(function(t){return Math.round(t.x)}).attr({x:function(t){return p(t.x)},y:function(){return-26},height:30,"text-anchor":"middle"}),D.enter().append("line").attr("class",function(t,a){return a===l.data.length-2?"line-price-visible hidden":"line-price-visible"}),D.exit().remove(),D.transition().duration(s?0:250).attr({x1:function(t){return p(t.x)},y1:function(){return 0},x2:function(t){return p(t.x)},y2:function(t){return h(t.y)}}),A.enter().append("line").attr("class",function(t,a){return a===l.data.length-2?"line-price hidden":"line-price"}).call(P),A.exit().remove(),A.transition().duration(s?0:250).attr({x1:function(t){return p(t.x)},y1:function(){return 0},x2:function(t){return p(t.x)},y2:function(t){return h(t.y)}}),k.enter().append("circle").attr("class",function(t,a){return 0===a||a===l.data.length-1?"draggable circle-hidden":"draggable"}).attr("r",0).call(b),k.transition().duration(s?0:250).attr({r:5,cx:function(t){return p(t.x)},cy:function(t){return h(t.y)}}),k.exit().remove(),this.pubDays>0&&(M.enter().append("line").attr("class","line-today-price-visible"),M.exit().remove(),M.transition().duration().attr({x1:function(){return p(lpc.pubDays)},y1:function(){return h(0)},x2:function(){return p(lpc.pubDays)},y2:function(){return h(lpc.maxPrice)}}),k.enter().append("circle").attr("class","point-today").attr("r",0).call(b),k.transition().duration(s?0:250).attr({r:5,cx:function(){return p(lpc.pubDays)},cy:function(){return h(lpc.todayPrice)}}),k.exit().remove());var Q,V=60};