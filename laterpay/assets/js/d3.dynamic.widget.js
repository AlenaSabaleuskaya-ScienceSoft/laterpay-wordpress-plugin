var margin={top:45,right:40,bottom:20,left:50};margin.xAxis=margin.left+margin.right,margin.yAxis=margin.top+margin.bottom;var LPCurve=function(t){var a,r=this;this.container=t,this.interpolation="linear",this.minPrice=0,this.maxPrice=5,this.todayPrice=0,this.pubDays=0,this.defaultPrice=.99,this.i18nDefaultPrice=lpVars.i18nDefaultPrice,this.currency=lpVars.currency,this.i18nDays=lpVars.i18nDays,this.i18nToday=lpVars.i18nToday,this.dragging=!1,a=d3.select(t).append("svg").append("g"),a.append("rect").attr("class","lp_dynamic-pricing-widget-background"),a.append("g").attr("class","x axis"),a.append("g").attr("class","y axis"),a.append("defs").append("marker").attr({id:"arrow-x","class":"lp_dynamic-pricing-widget-arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,0 V4 L4,2 Z"),a.append("defs").append("marker").attr({id:"arrow-y","class":"lp_dynamic-pricing-widget-arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,4 H4 L2,0 Z"),a.append("line").attr("class","lp_default-price"),a.append("text").attr("text-anchor","middle").attr("class","lp_default-price").text(this.i18nDefaultPrice),a.append("path").attr("class","line"),a.append("rect").attr({"class":"start-price",width:32,rx:3,height:29,ry:3}),a.append("text").attr("class","start-price").attr("text-anchor","end"),a.append("text").attr("class","start-price-currency").attr("text-anchor","end").text(this.currency),a.append("path").attr("class","start-price-triangle"),a.append("rect").attr({"class":"end-price",width:32,rx:3,height:29,ry:3}),a.append("text").attr("class","end-price").attr("text-anchor","end"),a.append("text").attr("class","end-price-currency").attr("text-anchor","end").text(this.currency),a.append("path").attr("class","end-price-triangle"),this.svg=a,jQuery(window).bind("resize",function(){r.plot()})};LPCurve.prototype.interpolate=function(t){return this.interpolation=t,this},LPCurve.prototype.setPrice=function(t,a,r){return this.minPrice=t,this.maxPrice=a,r&&(this.defaultPrice=r),this},LPCurve.prototype.set_data=function(t){return this.data=t,this},LPCurve.prototype.set_today=function(t,a){return this.pubDays=t,this.todayPrice=a,this},LPCurve.prototype.get_data=function(){return this.data},LPCurve.prototype.plot=function(){function t(t,a){var r=h.invert(d3.event.y);r<y[0]&&(r=y[0]),r>y[1]&&(r=y[1]),t.y=r,0===a&&l.data[0].x===t.x?l.data[1].y=t.y:1===a?l.data[0].y=t.y:0===a&&l.data[l.data.length-1].x===t.x?l.data[l.data.length-2].y=t.y:a===l.data.length-2&&(l.data[l.data.length-1].y=t.y),l.plot()}function a(){l.dragging=!0,jQuery(l.container).toggleClass("lp_is_dragging")}function r(){l.dragging=!1,jQuery(l.container).toggleClass("lp_is_dragging")}function e(){clearInterval(j),jQuery(l.container).toggleClass("ew-resize"),l.dragging=!1;for(var t=0,a=l.data.length;a>t;t++)l.data[t].x=Math.round(l.data[t].x);l.plot()}function n(){jQuery(l.container).toggleClass("ew-resize"),l.dragging=!0}function i(t,a){var r,e=x.invert(d3.event.x),n=a===l.data.length-2,i=a===l.data.length-3;if(n){var c=(e-t.x)/(1e3/Q),d=function(){r=+t.x+c,r=Math.max(r,l.data[a].x+.51),r=Math.max(r,29.51),r=Math.min(r,60.49),t.x=r,x.domain(d3.extent(l.data,function(t){return t.x})),l.plot()};clearInterval(j),j=setInterval(d,1e3/Q),d()}else i?(r=e,r=Math.max(r,l.data[a].x+.51),r=Math.min(r,60.49),l.data[a+2].x=r>=25?r+5:30,t.x=r,x.domain(d3.extent(l.data,function(t){return t.x})),l.plot()):(r=e,r=Math.max(r,l.data[a].x+.51),r=Math.min(r,l.data[a+2].x-.51),t.x=r,x.domain(d3.extent(l.data,function(t){return t.x})),l.plot())}var c,d,l=this,s=this.svg,o=this.dragging,u=jQuery(this.container).width()-margin.xAxis,p=jQuery(this.container).height()-margin.yAxis,x=d3.scale.linear().range([0,u+10]),h=d3.scale.linear().range([p,0]);d3.select(this.container).select("svg").attr({width:u+margin.xAxis,height:p+margin.yAxis}).select("g").attr("transform","translate("+(margin.left-10)+","+margin.top+")"),s.select(".lp_dynamic-pricing-widget-background").transition().duration(o?0:250).attr({width:u+10,height:p});var g=d3.extent(l.data,function(t){return t.x}),y=[this.minPrice,this.maxPrice],f=d3.svg.axis().scale(x).tickSize(-p,0,0).ticks(7).orient("bottom"),m=d3.svg.axis().scale(h).tickSize(-p,0,0).ticks(7).orient("left");x.domain(g),h.domain(y),s.select("g.x.axis").attr({transform:"translate(0,"+p+")","marker-end":"url(#arrow-x)"}).transition().duration(o?0:250).call(f),s.select("g.y.axis").attr("marker-start","url(#arrow-y)").transition().duration(o?0:250).call(m),s.select("line.lp_default-price").transition().duration(o?0:250).attr({x1:0,y1:h(this.defaultPrice),x2:u+10,y2:h(this.defaultPrice)}),s.select("text.lp_default-price").transition().duration(o?0:250).attr({x:u/2,y:h(l.defaultPrice)});var v=d3.svg.line().interpolate(this.interpolation).x(function(t){return x(t.x)}).y(function(t){return h(t.y)});s.select("path.line").datum(l.data).transition().duration(o?0:250).attr("d",v);var _=d3.behavior.drag().on("dragstart",n).on("drag",i).on("dragend",e),P=d3.behavior.drag().on("dragstart",a).on("drag",t).on("dragend",r),b=l.data.length,w=s.selectAll("circle.draggable").data(l.data),k=s.selectAll(".line-price").data(l.data.slice(1,b)),A=s.selectAll(".today-price-line").data(l.data.slice(1,b)),D=s.selectAll(".line-price-visible").data(l.data.slice(1,b));s.select("rect.start-price").datum(l.data[0]).call(P).transition().duration(o?0:250).attr({x:function(){return-40},y:function(t){return h(t.y)-14.5}}),s.select("text.start-price").datum(l.data[0]).call(P).transition().duration(o?0:250).attr({x:function(){return-12},y:function(t){return h(t.y)-.5}}).text(function(t){return t.y.toFixed(2)}),s.select("text.start-price-currency").datum(l.data[0]).call(P).transition().duration(o?0:250).attr({x:function(){return-13},y:function(t){return h(t.y)+9.5}}),s.select("path.start-price-triangle").datum(l.data[0]).call(P).transition().duration(o?0:250).attr("d",function(t){return c=-8,d=h(t.y)-5,"M "+c+" "+d+" l 5 5 l -5 5 z"}),s.select("rect.end-price").datum(l.data[l.data.length-1]).call(P).transition().duration(o?0:250).attr({x:function(){return u+18},y:function(t){return h(t.y)-15}}),s.select("text.end-price").datum(l.data[l.data.length-1]).call(P).transition().duration(o?0:250).attr({x:function(){return u+46},y:function(t){return h(t.y)-1}}).text(function(t){return t.y.toFixed(2)}),s.select("text.end-price-currency").datum(l.data[l.data.length-1]).call(P).transition().duration(o?0:250).attr({x:function(){return u+46},y:function(t){return h(t.y)+9}}),s.select("path.end-price-triangle").datum(l.data[l.data.length-1]).call(P).transition().duration(o?0:250).attr("d",function(t){return c=u+18,d=h(t.y)+5,"M "+c+" "+d+" l 0 -10 l -5 5 z"});var M=s.selectAll(".x-drag-square").data(l.data.slice(1,b));M.enter().append("rect").attr("class",function(t,a){return a===l.data.length-2?"x-drag-square lp_is_hidden":"x-drag-square"}).call(_),M.exit().remove(),M.transition().duration(o?0:250).attr({x:function(t){return x(t.x)-15},y:function(){return-40},width:30,rx:3,height:30,ry:3});var C=s.selectAll(".x-triangle-bottom").data(l.data.slice(1,b));C.enter().append("path").attr("class",function(t,a){return a===l.data.length-2?"x-triangle-bottom lp_is_hidden":"x-triangle-bottom"}).call(_),C.exit().remove(),C.transition().duration(o?0:250).attr("d",function(t){return c=x(t.x)-5,d=-10,"M "+c+" "+d+" l 10 0 l -5 5 z"});var L=s.selectAll(".x-text-days").data(l.data.slice(1,b));L.enter().append("text").attr("class",function(t,a){return a===l.data.length-2?"x-text-days lp_is_hidden":"x-text-days"}).call(_),L.exit().remove(),L.transition().duration(o?0:250).text(this.i18nDays).attr({x:function(t){return x(t.x)},y:function(){return-16},height:30,"text-anchor":"middle"});var z=s.selectAll(".x-text").data(l.data.slice(1,b));z.enter().append("text").attr("class",function(t,a){return a===l.data.length-2?"x-text lp_is_hidden":"x-text"}).call(_),z.exit().remove(),z.transition().duration(o?0:250).text(function(t){return Math.round(t.x)}).attr({x:function(t){return x(t.x)},y:function(){return-26},height:30,"text-anchor":"middle"}),D.enter().append("line").attr("class",function(t,a){return a===l.data.length-2?"line-price-visible lp_is_hidden":"line-price-visible"}),D.exit().remove(),D.transition().duration(o?0:250).attr({x1:function(t){return x(t.x)},y1:function(){return 0},x2:function(t){return x(t.x)},y2:function(t){return h(t.y)}}),k.enter().append("line").attr("class",function(t,a){return a===l.data.length-2?"line-price lp_is_hidden":"line-price"}).call(_),k.exit().remove(),k.transition().duration(o?0:250).attr({x1:function(t){return x(t.x)},y1:function(){return 0},x2:function(t){return x(t.x)},y2:function(t){return h(t.y)}}),w.enter().append("circle").attr("class",function(t,a){return 0===a||a===l.data.length-1?"draggable circle-hidden":"draggable"}).attr("r",0).call(P),w.transition().duration(o?0:250).attr({r:5,cx:function(t){return x(t.x)},cy:function(t){return h(t.y)}}),w.exit().remove(),this.pubDays>0&&(A.enter().append("line").attr("class","lp_current-price-line"),A.exit().remove(),A.transition().duration().attr({x1:function(){return x(lpc.pubDays)},y1:function(){return h(0)},x2:function(){return x(lpc.pubDays)},y2:function(){return h(lpc.maxPrice)}}),w.enter().append("circle").attr("class","lp_current-price-point").attr("r",0).call(P),w.transition().duration(o?0:250).attr({r:5,cx:function(){return x(lpc.pubDays)},cy:function(){return h(lpc.todayPrice)}}),w.exit().remove(),s.append("text").attr("class","lp_default-price").attr("text-anchor","end").text(this.i18nToday).datum({x:lpc.pubDays,y:lpc.todayPrice}).call(P).attr({x:function(){return x(parseInt(lpc.pubDays,10)+2)},y:function(){return h(-10)}}));var j,Q=60};