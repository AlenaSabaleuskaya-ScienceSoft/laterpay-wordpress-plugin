var margin={top:45,right:40,bottom:20,left:50};margin.xAxis=margin.left+margin.right,margin.yAxis=margin.top+margin.bottom;var LPCurve=function(t){var e,r=this;this.container=t,this.interpolation="linear",this.minPrice=0,this.maxPrice=5,this.todayPrice=0,this.pubDays=0,this.defaultPrice=.99,this.i18nDefaultPrice=lpVars.i18nDefaultPrice,this.currency=lpVars.currency,this.i18nDays=lpVars.i18nDays,this.i18nToday=lpVars.i18nToday,this.dragging=!1,e=d3.select(t).append("svg").append("g"),e.append("rect").attr("class","lp_dynamic-pricing-widget-background"),e.append("g").attr("class","x axis"),e.append("g").attr("class","y axis"),e.append("defs").append("marker").attr({id:"arrow-x","class":"lp_dynamic-pricing-widget-arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,0 V4 L4,2 Z"),e.append("defs").append("marker").attr({id:"arrow-y","class":"lp_dynamic-pricing-widget-arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,4 H4 L2,0 Z"),e.append("line").attr("class","lp_default-price"),e.append("text").attr("text-anchor","middle").attr("class","lp_default-price").text(this.i18nDefaultPrice),e.append("path").attr("class","line"),e.append("rect").attr({"class":"start-price",width:32,rx:3,height:29,ry:3}),e.insert("foreignObject").attr("class","start-input").attr("width","44px").attr("height","24px").html('<input type="text">').attr("display","none"),e.append("text").attr("class","start-price").attr("text-anchor","end"),e.append("text").attr("class","start-price-currency").attr("text-anchor","end").text(this.currency),e.append("path").attr("class","start-price-triangle"),e.append("rect").attr({"class":"end-price",width:32,rx:3,height:29,ry:3}),e.insert("foreignObject").attr("class","end-input").attr("width","44px").attr("height","24px").html('<input type="text">').attr("display","none"),e.append("text").attr("class","end-price").attr("text-anchor","end"),e.append("text").attr("class","end-price-currency").attr("text-anchor","end").text(this.currency),e.append("path").attr("class","end-price-triangle"),this.svg=e,jQuery(window).bind("resize",function(){r.plot()}),jQuery("body").on("click",".start-price,.start-price-currency,.start-price-triangle",function(){lpc.toggleStartInput("show")}),jQuery(".start-input input").change(function(){lpc.toggleStartInput("hide")}),jQuery(".start-input input").focusout(function(){lpc.toggleStartInput("hide")}),jQuery(".start-input input").keydown(function(t){var e=t.charCode?t.charCode:t.keyCode?t.keyCode:0;13===e&&(t.preventDefault(),lpc.toggleStartInput("hide"))}),jQuery("body").on("click",".end-price, .end-price-currency, .end-price-triangle",function(){lpc.toggleEndInput("show")}),jQuery(".end-input input").change(function(){lpc.toggleEndInput("hide")}),jQuery(".end-input input").focusout(function(){lpc.toggleEndInput("hide")}),jQuery(".end-input input").keydown(function(t){var e=t.charCode?t.charCode:t.keyCode?t.keyCode:0;13===e&&(t.preventDefault(),lpc.toggleEndInput("hide"))})};LPCurve.prototype.interpolate=function(t){return this.interpolation=t,this},LPCurve.prototype.setPrice=function(t,e,r){return this.minPrice=t,this.maxPrice=e,r&&(this.defaultPrice=r),this},LPCurve.prototype.set_data=function(t){return this.data=t,this},LPCurve.prototype.set_today=function(t,e){return this.pubDays=t,this.todayPrice=e,this},LPCurve.prototype.get_data=function(){return this.data},LPCurve.prototype.plot=function(){function t(t,e){var r=x.invert(d3.event.y);r<g[0]&&(r=g[0]),r>g[1]&&(r=g[1]),t.y=r,0===e&&d.data[0].x===t.x?d.data[1].y=t.y:1===e?d.data[0].y=t.y:0===e&&d.data[d.data.length-1].x===t.x?d.data[d.data.length-2].y=t.y:e===d.data.length-2&&(d.data[d.data.length-1].y=t.y),d.plot()}function e(){d.dragging=!0,jQuery(d.container).toggleClass("lp_is_dragging")}function r(){d.dragging=!1,jQuery(d.container).toggleClass("lp_is_dragging"),lpc.toggleStartInput("update"),lpc.toggleEndInput("update")}function a(){clearInterval(D),jQuery(d.container).toggleClass("ew-resize"),d.dragging=!1;for(var t=0,e=d.data.length;e>t;t++)d.data[t].x=Math.round(d.data[t].x);d.plot()}function n(){jQuery(d.container).toggleClass("ew-resize"),d.dragging=!0}function i(t,e){var r,a=h.invert(d3.event.x),n=e===d.data.length-2,i=e===d.data.length-3;if(n){var c=(a-t.x)/(1e3/L),u=function(){r=+t.x+c,r=Math.max(r,d.data[e].x+.51),r=Math.max(r,29.51),r=Math.min(r,60.49),t.x=r,h.domain(d3.extent(d.data,function(t){return t.x})),d.plot()};clearInterval(D),D=setInterval(u,1e3/L),u()}else i?(r=a,r=Math.max(r,d.data[e].x+.51),r=Math.min(r,60.49),d.data[e+2].x=r>=25?r+5:30,t.x=r,h.domain(d3.extent(d.data,function(t){return t.x})),d.plot()):(r=a,r=Math.max(r,d.data[e].x+.51),r=Math.min(r,d.data[e+2].x-.51),t.x=r,h.domain(d3.extent(d.data,function(t){return t.x})),d.plot())}var c,u,d=this,l=this.svg,s=this.dragging,p=jQuery(this.container).width()-margin.xAxis,o=jQuery(this.container).height()-margin.yAxis,h=d3.scale.linear().range([0,p+10]),x=d3.scale.linear().range([o,0]);d3.select(this.container).select("svg").attr({width:p+margin.xAxis,height:o+margin.yAxis}).select("g").attr("transform","translate("+(margin.left-10)+","+margin.top+")"),l.select(".lp_dynamic-pricing-widget-background").transition().duration(s?0:250).attr({width:p+10,height:o});var y=d3.extent(d.data,function(t){return t.x}),g=[0,this.maxPrice],f=d3.svg.axis().scale(h).tickSize(-o,0,0).ticks(7).orient("bottom"),m=d3.svg.axis().scale(x).tickSize(-o,0,0).ticks(7).orient("left");h.domain(y),x.domain(g),l.select("g.x.axis").attr({transform:"translate(0,"+o+")","marker-end":"url(#arrow-x)"}).transition().duration(s?0:250).call(f),l.select("g.y.axis").attr("marker-start","url(#arrow-y)").transition().duration(s?0:250).call(m),l.select("line.lp_default-price").transition().duration(s?0:250).attr({x1:0,y1:x(this.defaultPrice),x2:p+10,y2:x(this.defaultPrice)}),l.select("text.lp_default-price").transition().duration(s?0:250).attr({x:p/2,y:x(d.defaultPrice)});var v=d3.svg.line().interpolate(this.interpolation).x(function(t){return h(t.x)}).y(function(t){return x(t.y)});l.select("path.line").datum(d.data).transition().duration(s?0:250).attr("d",v);var j=d3.behavior.drag().on("dragstart",n).on("drag",i).on("dragend",a),Q=d3.behavior.drag().on("dragstart",e).on("drag",t).on("dragend",r),P=d.data.length,w=l.selectAll("circle.draggable").data(d.data),b=l.selectAll(".line-price").data(d.data.slice(1,P)),_=l.selectAll(".today-price-line").data(d.data.slice(1,P)),k=l.selectAll(".line-price-visible").data(d.data.slice(1,P));l.select("rect.start-price").datum(d.data[0]).call(Q).transition().duration(s?0:250).attr({x:function(){return-40},y:function(t){return x(t.y)-14.5}}),l.select("text.start-price").datum(d.data[0]).call(Q).transition().duration(s?0:250).attr({x:function(){return-12},y:function(t){return x(t.y)-.5}}).text(function(t){return t.y.toFixed(2)}),l.select("text.start-price-currency").datum(d.data[0]).call(Q).transition().duration(s?0:250).attr({x:function(){return-13},y:function(t){return x(t.y)+9.5}}),l.select("path.start-price-triangle").datum(d.data[0]).call(Q).transition().duration(s?0:250).attr("d",function(t){return c=-8,u=x(t.y)-5,"M "+c+" "+u+" l 5 5 l -5 5 z"}),l.select(".start-input").datum(d.data[0]).call(Q).transition().duration(s?0:250).attr({x:function(){return-38},y:function(t){return x(t.y)-12.5}}),l.select("rect.end-price").datum(d.data[d.data.length-1]).call(Q).transition().duration(s?0:250).attr({x:function(){return jQuery(".end-input")&&jQuery(".end-input").is(":visible")?p:p+16},y:function(t){return x(t.y)-15}}),l.select("text.end-price").datum(d.data[d.data.length-1]).call(Q).transition().duration(s?0:250).attr({x:function(){return p+46},y:function(t){return x(t.y)-1}}).text(function(t){return t.y.toFixed(2)}),l.select("text.end-price-currency").datum(d.data[d.data.length-1]).call(Q).transition().duration(s?0:250).attr({x:function(){return p+46},y:function(t){return x(t.y)+9}}),l.select("path.end-price-triangle").datum(d.data[d.data.length-1]).call(Q).transition().duration(s?0:250).attr("d",function(t){return c=p+18,u=x(t.y)+5,"M "+c+" "+u+" l 0 -10 l -5 5 z"}),l.select(".end-input").datum(d.data[d.data.length-1]).call(Q).transition().duration(s?0:250).attr({x:function(){return jQuery(".end-input")&&jQuery(".end-input input").is(":visible")?p+2:p+20},y:function(t){return x(t.y)-13}});var C=l.selectAll(".x-drag-square").data(d.data.slice(1,P));C.enter().append("rect").attr("class",function(t,e){return e===d.data.length-2?"x-drag-square lp_is_hidden":"x-drag-square"}).call(j),C.exit().remove(),C.transition().duration(s?0:250).attr({x:function(t){return h(t.x)-15},y:function(){return-40},width:30,rx:3,height:30,ry:3});var I=l.selectAll(".x-triangle-bottom").data(d.data.slice(1,P));I.enter().append("path").attr("class",function(t,e){return e===d.data.length-2?"x-triangle-bottom lp_is_hidden":"x-triangle-bottom"}).call(j),I.exit().remove(),I.transition().duration(s?0:250).attr("d",function(t){return c=h(t.x)-5,u=-10,"M "+c+" "+u+" l 10 0 l -5 5 z"});var M=l.selectAll(".x-text-days").data(d.data.slice(1,P));M.enter().append("text").attr("class",function(t,e){return e===d.data.length-2?"x-text-days lp_is_hidden":"x-text-days"}).call(j),M.exit().remove(),M.transition().duration(s?0:250).text(this.i18nDays).attr({x:function(t){return h(t.x)},y:function(){return-16},height:30,"text-anchor":"middle"});var A=l.selectAll(".x-text").data(d.data.slice(1,P));A.enter().append("text").attr("class",function(t,e){return e===d.data.length-2?"x-text lp_is_hidden":"x-text"}).call(j),A.exit().remove(),A.transition().duration(s?0:250).text(function(t){return Math.round(t.x)}).attr({x:function(t){return h(t.x)},y:function(){return-26},height:30,"text-anchor":"middle"}),k.enter().append("line").attr("class",function(t,e){return e===d.data.length-2?"line-price lp_is_hidden":"line-price-visible"}),k.exit().remove(),k.transition().duration(s?0:250).attr({x1:function(t){return h(t.x)},y1:function(){return 0},x2:function(t){return h(t.x)},y2:function(t){return x(t.y)}}),b.enter().append("line").attr("class",function(t,e){return e===d.data.length-2?"line-price lp_is_hidden":"line-price"}).call(j),b.exit().remove(),b.transition().duration(s?0:250).attr({x1:function(t){return h(t.x)},y1:function(){return 0},x2:function(t){return h(t.x)},y2:function(t){return x(t.y)}}),w.enter().append("circle").attr("class",function(t,e){return 0===e||e===d.data.length-1?"draggable circle-hidden":"draggable"}).attr("r",0).call(Q),w.transition().duration(s?0:250).attr({r:5,cx:function(t){return h(t.x)},cy:function(t){return x(t.y)}}),w.exit().remove(),this.pubDays>0&&(_.enter().append("line").attr("class","lp_current-price-line"),_.exit().remove(),_.transition().duration().attr({x1:function(){return h(lpc.pubDays)},y1:function(){return x(0)},x2:function(){return h(lpc.pubDays)},y2:function(){return x(lpc.maxPrice)}}),l.append("text").attr("class","lp_default-price").attr("text-anchor","end").text(this.i18nToday).datum({x:lpc.pubDays,y:lpc.todayPrice}).call(Q).attr({x:function(){return h(parseInt(lpc.pubDays,10)+2)},y:function(){return x(-10)}}));var D,L=60},LPCurve.prototype.toggleStartInput=function(t){var e=1,r=lpc.get_data(),a=r[0].y,n=jQuery(".start-input input").val();if(n=parseFloat(n.indexOf(",")>-1?n.replace(",","."):n),"hide"===t)n>this.maxPrice?(jQuery(".start-input input").val(this.maxPrice),r[0].y=this.maxPrice,r[1].y=this.maxPrice):n<this.minPrice&&0!==n?(jQuery(".start-input input").val(this.minPrice),r[0].y=this.minPrice,r[1].y=this.minPrice):n>=0&&(r[0].y=n,r[1].y=n),lpc.set_data(r),jQuery("rect.start-price").attr("width","32px"),jQuery(".start-input").hide(),jQuery("path.start-price-triangle, text.start-price-currency, text.start-price").show(),lpc.plot();else if("show"===t)jQuery("rect.start-price").attr("width","50px"),jQuery("path.start-price-triangle, text.start-price-currency, text.start-price").hide(),jQuery(".start-input").show(),jQuery(".start-input input").val(a.toFixed(2));else if("update"===t&&jQuery(".start-input input").is(":visible")){var i=Math.abs(a-n);i>e&&jQuery(".start-input input").val(a.toFixed(2))}},LPCurve.prototype.toggleEndInput=function(t){var e=1,r=lpc.get_data(),a=r[2].y,n=jQuery(".end-input input").val(),i=jQuery(this.container).width()-margin.xAxis;if(n=parseFloat(n.indexOf(",")>-1?n.replace(",","."):n),"hide"===t)n>this.maxPrice?(jQuery(".end-input input").val(this.maxPrice),r[0].y=this.maxPrice,r[1].y=this.maxPrice):n<this.minPrice&&0!==n?(jQuery(".end-input input").val(this.minPrice),r[2].y=this.minPrice,r[3].y=this.minPrice):n>=0&&(r[2].y=n,r[3].y=n),lpc.set_data(r),jQuery("rect.end-price").attr("width","32px"),jQuery(".end-input").hide(),jQuery("path.end-price-triangle, text.end-price-currency, text.end-price").show(),lpc.plot();else if("show"===t)jQuery("rect.end-price").attr("width","50px").attr("x",i),jQuery("path.end-price-triangle, text.end-price-currency, text.end-price").hide(),jQuery(".end-input").attr("x",i+2).show(),jQuery(".end-input input").val(a.toFixed(2));else if("update"===t&&jQuery(".end-input input").is(":visible")){var c=Math.abs(a-n);c>e&&jQuery(".end-input input").val(a.toFixed(2))}};